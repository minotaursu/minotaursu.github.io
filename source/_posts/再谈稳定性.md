title: 再谈稳定性工作
date: 2019-04-11 16:33:17
tags:
- 工作
- 性能
- 稳定性
- 高可用
- 高并发

---

之前也写过一篇稳定性相关的事情[如何保障高并发系统的稳定性与高可用](http://minotaursu.com/2018/03/12/%E5%A6%82%E4%BD%95%E4%BF%9D%E9%9A%9C%E9%AB%98%E5%B9%B6%E5%8F%91%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%A8%B3%E5%AE%9A%E6%80%A7%E4%B8%8E%E9%AB%98%E5%8F%AF%E7%94%A8/)，但更多的是从系统开发者的角度出发来说明如何保障单一系统的稳定性，做好自己负责的系统的稳定性建设更多的是依赖知识和经验，是个技术活。再负责了一整年的业务线稳定性建设之后，对于如何保障几十个系统的稳定性，协同几十人做好稳定性相关工作有了更多的思考和实践，又有了些新的体会，做好几十个系统的稳定性建设需要科学的工程管理，涉及到多个方面。

## 方向
1. 高可用
高可用要求系统有比较高的风险防范应对能力，把因软件/硬件/人为造成的故障对业务的影响降低到最小程度。系统能够对外提供有效服务的时间大于99.9%，99.99%，甚至是99.999%。 
2. 零资损
高可用强调的是对外稳定服务，零资损强调的是内部资金安全。减少软件/硬件/人为的因素导致的资金损失风险。特别是计费，交易，营销这些和钱相关的系统。

![](https://raw.githubusercontent.com/minotaursu/minotaursu.github.io/source/images/direction.png)

## 维度
1. 流程规范
一个行之有效的流程对系统稳定性有着至关重要的作用。把流程规范的建立作为稳定性建设的开始是一个比较好的选择，不需要付出非常巨大的成本，但对稳定性的提升有着很大的帮助。好的流程规范应该覆盖项目整个生命周期（需求评审，项目管理，项目开发，code review，测试用例评审，上线流程，故障通报，故障复盘）尽可能的帮助开发避免风险点。
2. 基础设施
基础设施建设是稳定性建设的核心方向。科技是第一生产力，工具可以带来能力和效率的大幅提升。只有具备完备而且强大的工具才有可能保障复杂系统的高可用，试想如果没有监控报警就连最基础的故障感知都无法做到，缺少运维工具的辅助想要做到故障的快速恢复更是天方夜谭。
3. 稳定性意识
稳定性意识的提升是最基础也是最难的工作。很多人眼里只有业务功能，很少关心稳定性工作，需要在日常文化中强调稳定性的重要性，通过例会，巡检，定期演练的方式提升大家的稳定性意识。

![](https://raw.githubusercontent.com/minotaursu/minotaursu.github.io/source/images/metrics.png)

## 阶段
1. 事前
事前重在风险的发现和预防，做好容量规划，服务治理，系统优化，慢查优化，提升系统鲁棒性。
2. 事中
事中重在最快止损，最快定位。止损是第一优先级的事情，需要提前准备好故障预案。定位则依赖完备的工具和对系统业务的熟悉。
3. 事后
事后重在修复故障影响，复盘和改进。一个故障的发生一定是要做到闭环的，必然存在可改进项，同时也要做到对事不对人。

![](https://raw.githubusercontent.com/minotaursu/minotaursu.github.io/source/images/stage.png)

## 架构
1. 网络层
网络层是系统架构中不确定性最高的部分。用户通过网络访问系统服务，网络的延迟和成功率直接影响着用户的体验，很可能由于运营商的设备升级和道路施工导致网络不可用，并且机房断电，火灾，地震..这些极端因素都会导致业务瘫痪，如果业务期望达到即使在此类灾难性故障的情况下，业务也不受影响，或者在几分钟内就能够很快恢复，那么就需要设计异地多活架构。根据地理位置上的距离来划分，异地多活架构可以分为同城异区、跨城异地、跨国异地。多活架构的最大难点就是地理位置导致的数据同步延迟和业务上强一致的矛盾。
2. 应用层
应用层是系统架构中复杂度最高变化最频繁的部分。一个使用微服务架构的业务线涉及到几十个系统，几百个服务，几千个接口，系统间存在大量的交互，如何做好服务治理，保障应用层的稳定性是一个重大的挑战。
3. 存储层
存储层是系统架构中最需要被保护的部分。存储层即强大又脆弱，缓存是系统高性能的核心，使系统能够承载高并发的流量带来的压力，同时缓存的穿透，雪崩也往往会导致大故障。mysql则是更加的脆弱，一个无索引的慢查，几个大事务都可能导致数据库的瘫痪。
4. 中间件
中间件作为系统架构中的数据通道和流量通道，是稳定性发力的支点。可以通过在中间件中集成服务治理，限流，降级等策略使尽可能多的应用系统收益，中间件的一小步的优化往往会带来系统稳定性的一大步提升。

![](https://raw.githubusercontent.com/minotaursu/minotaursu.github.io/source/images/layerx.png)


## 架构原则
1. 冗余 
冗余是高可用架构的核心原则。好的架构需要做到对流量冗余，资源冗余，硬件冗余，也是异地多活，集群部署，容量规划的核心思想。
2. 隔离
隔离是高可用架构的另一个核心原则。除了冗余之外也需要做好故障隔离，资源隔离，前后台隔离，在线离线隔离，防止故障在线程，进程，应用，领域之间的传播，小的风险演变成大的事故。

## 全局工作概览
最后是一张全局工作概览图，有些已经做的比较成熟，有些还需要继续完善。

![](https://raw.githubusercontent.com/minotaursu/minotaursu.github.io/source/images/availability.png)
