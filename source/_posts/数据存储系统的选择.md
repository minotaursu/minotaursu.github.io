title: 数据存储系统的选择
date: 2019-05-08 09:39:02
tags:
- 分布式
- 存储
- 大数据

---

数据库作为应用系统中最重要的基础设施，承载着通过数据访问接口
存储和查询用户信息的功能，当今的互联网业务场景越来越丰富和复杂，并且数据库作为有状态服务扩展成本高昂，选择适合业务场景的数据变的十分重要。本文分别对比一些常用的数据库（包括mysql，redis，mongodb，hbase，elasticsearch，influxdb，rocksdb），通过简要分析其中的原理确定每种数据库适合场景和优缺点。

## mysql
mysql作为典型的关系型数据库在互联网和传统软件行业都有着广泛的应用。mysql的优点是有着最完备的单机功能（增删改查，事务，关联）和最丰富的社区生态。缺点则是在高并发场景下单机性能一般，不支持auto-sharding需要额外的proxy，schema模型不能便捷的增加字段。适合场景有复杂事务，低性能需求数据关联，一般性业务等

## redis
redis作为key-value存储有着良好的性能，并且redis相比memcache有着更丰富的数据结构，在非持久化场景中可以作为高性能缓存使用，在持久化场景中可以作为关系型数据库的补充。对于需要集群使用的场景codis是一个不错的选择。合适场景有高性能缓存，少量数据持久化存储。

## mongodb
mongodb是一个高性能的文档型数据库，以BSON的格式保存数据，优点是schema-free模式非常适合增加字段，并且自带auto-sharding的集群分片功能在数据扩容方面有着明显的优势，也有着geohash等丰富功能。缺点则是事务方面较弱，并且不支持关联查询。适合的场景有物联网，视频，地理位置，社交等。

## hbase
hbase是基于LSM（Log-StructuredMergeTree）的思想，LSM树和B+树相比，LSM树牺牲了部分读性能，用来大幅提高写性能。hbase适合写多读少的场景，并且hbase没有二级索引，只支持单rowkey，rowkey的range，全表扫描3种方式。适合的场景有搜索引擎和推荐系统底层的数据存储，监控日志存储。

## elasticsearch
elasticsearch是基于Lucene构建的搜索引擎，除了作为全文搜索之外也可以作为nosql数据使用。适合的场景有搜索引擎，数据可视化，日志检索系统，后台客服系统。

## influxdb
influxDB是目前最流行的时序数据库，存储引擎称为TSM，基本架构类似于LSM。数据按照key组织，influxDB中key由维度集合加上某一个列值名构成，所有属于该维度集合加列值的时间序列数值组成的一个集合就挂在该key下。适合的场景有物联网，监控。

## rocksdb
rocksdb并非一个完整的数据库系统，而是基于LevelDB开发的一种嵌入式Key-value存储系统，该数据库能够充分利用闪存的性能，大大提升应用服务器的速度。引入了 LSM 树，就是为了解决 B+ 树随机写性能低的问题，它把随机写以跳跃表的形式保留在内存中（memtable），积累到足够的大小就不再改写它了，并将其写入到磁盘（L0 SST file），这样就只有顺序写了。合适的场景是多种数据库的存储引擎。

## sharding策略
分布式数据库一般有两种Sharding策略：Range Sharding和Hash Sharding。

#### range
range假设key有序，好处是临近的key经常在一起，比如共同前缀的key,可以很好的支持scan操作，hbase的region就是range策略。缺点是对压力较大的顺序写不太友好，比如日志类型的写入，一般日志的key都是和时间相关的，时间是单调递增的，因此写入的热点永远在最后一个region。

#### round-hash
把数据mod后直接映射到真实节点上面，这造成节点个数和数据的紧密关联、后期缺乏灵活扩展。

#### consistent-hash
多增加一层虚拟映射层，数据与虚拟节点映射、虚拟节点与真实节点再映射，减少扩容和宕机情况下数据迁移的影响。

#### hash-slot
采用固定节点数量，来避免取模的不灵活性。采用可配置映射节点，来避免一致性哈希的部分影响。

## 数据同步
数据同步保证同一个数据分片的多个副本之间的数据一致性，一般的数据同步算法有异步，半同步（ISR的机制），全同步，paxos，raft，gossip。异步复制有最佳的性能，最可能的数据丢失/不一致问题，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间，全同步有着最好的数据一致性和最差的性能。paxos利用过半选举的机制，保证了集群数据副本的一致性，raft是paxos的简化版本，更易于理解的工程实现，ggossip利用去中心化的协议进行数据同步，好处是无任何单点故障，坏处是同步时间过长。

参考：
[2PC到3PC到Paxos到Raft到ISR](https://segmentfault.com/a/1190000004474543)
[分布式一致性机制整理](https://segmentfault.com/a/1190000014503967)